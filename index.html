import React, { useState, useEffect, useRef } from 'react';
import { MapPin, Plus, X, Home, Clock, User, Trash2, AlertCircle } from 'lucide-react';

export default function ColindMap() {
  const [pins, setPins] = useState([]);
  const [showForm, setShowForm] = useState(false);
  const [clickedLocation, setClickedLocation] = useState(null);
  const [newPin, setNewPin] = useState({
    name: '',
    address: '',
    streetNumber: '',
    schedule: '',
    notes: '',
    icon: 'ğŸ„',
    password: ''
  });
  const [selectedPin, setSelectedPin] = useState(null);
  const [showDeleteForm, setShowDeleteForm] = useState(false);
  const [deletePassword, setDeletePassword] = useState('');
  const [errorMessage, setErrorMessage] = useState('');
  const [loading, setLoading] = useState(true);
  const [mapReady, setMapReady] = useState(false);
  const mapRef = useRef(null);
  const mapInstanceRef = useRef(null);
  const markersRef = useRef([]);

  useEffect(() => {
    loadPins();
  }, []);

  useEffect(() => {
    if (!mapRef.current || mapInstanceRef.current) return;

    const link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css';
    document.head.appendChild(link);

    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js';
    script.onload = () => {
      const L = window.L;
      
      const map = L.map(mapRef.current, {
        center: [44.545593, 25.931531],
        zoom: 17,
        zoomControl: true
      });
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(map);

      map.on('click', (e) => {
        setClickedLocation({ lat: e.latlng.lat, lng: e.latlng.lng });
        setShowForm(true);
      });

      mapInstanceRef.current = map;
      setMapReady(true);
      
      setTimeout(() => {
        map.invalidateSize();
      }, 100);
    };
    
    script.onerror = () => {
      console.error('Map loading error');
    };
    
    document.body.appendChild(script);

    return () => {
      if (mapInstanceRef.current) {
        mapInstanceRef.current.remove();
        mapInstanceRef.current = null;
      }
    };
  }, []);

  useEffect(() => {
    if (!mapInstanceRef.current || !window.L || !mapReady) return;

    const L = window.L;
    
    markersRef.current.forEach(marker => marker.remove());
    markersRef.current = [];

    pins.forEach(pin => {
      const iconEmoji = pin.icon || 'ğŸ„';
      const marker = L.marker([pin.lat, pin.lng], {
        icon: L.divIcon({
          html: `<div style="font-size: 42px; filter: drop-shadow(0 3px 6px rgba(0,0,0,0.4)); transform: translateY(-5px);">${iconEmoji}</div>`,
          className: 'custom-marker',
          iconSize: [42, 42],
          iconAnchor: [21, 42]
        })
      }).addTo(mapInstanceRef.current);

      // Add tooltip on hover
      const tooltipText = `<strong>${pin.name}</strong><br>Str. ${pin.address}, Nr. ${pin.streetNumber}`;
      marker.bindTooltip(tooltipText, {
        direction: 'top',
        offset: [0, -40],
        opacity: 0.95
      });

      marker.on('click', () => {
        setSelectedPin(pin);
        setShowForm(false);
      });
      
      markersRef.current.push(marker);
    });
  }, [pins, mapReady]);

  const loadPins = async () => {
    try {
      const result = await window.storage.list('colind:', true);
      if (result && result.keys) {
        const loadedPins = [];
        for (const key of result.keys) {
          try {
            const data = await window.storage.get(key, true);
            if (data && data.value) {
              loadedPins.push(JSON.parse(data.value));
            }
          } catch (e) {
            console.log('Key not found:', key);
          }
        }
        setPins(loadedPins);
      }
    } catch (error) {
      console.log('No pins yet');
    } finally {
      setLoading(false);
    }
  };

  const savePin = async () => {
    const missingFields = [];
    
    if (!newPin.name || newPin.name.trim() === '') {
      missingFields.push('Nume Familie');
    }
    if (!newPin.address || newPin.address.trim() === '') {
      missingFields.push('Denumire StradÄƒ');
    }
    if (!newPin.streetNumber || newPin.streetNumber.trim() === '') {
      missingFields.push('NumÄƒr PoÈ™tal');
    }
    
    if (missingFields.length > 0) {
      const message = 'Te rog completeazÄƒ urmÄƒtoarele cÃ¢mpuri obligatorii:\n\nâ€¢ ' + missingFields.join('\nâ€¢ ');
      setErrorMessage(message);
      return;
    }

    if (!clickedLocation) {
      setErrorMessage('Te rog selecteazÄƒ o locaÈ›ie pe hartÄƒ!');
      return;
    }

    const pinData = {
      ...newPin,
      lat: clickedLocation.lat,
      lng: clickedLocation.lng,
      id: Date.now().toString(),
      timestamp: new Date().toISOString()
    };

    try {
      await window.storage.set(`colind:${pinData.id}`, JSON.stringify(pinData), true);
      setPins(prev => [...prev, pinData]);
      setShowForm(false);
      setClickedLocation(null);
      setErrorMessage('');
      setNewPin({
        name: '',
        address: '',
        streetNumber: '',
        schedule: '',
        notes: '',
        icon: 'ğŸ„',
        password: ''
      });
    } catch (error) {
      console.error('Save error:', error);
      setErrorMessage('Eroare la salvare: ' + error.message);
    }
  };

  const deletePin = async (pinId) => {
    const pin = pins.find(p => p.id === pinId);
    if (!pin) {
      alert('Pin-ul nu a fost gÄƒsit!');
      return;
    }

    const ADMIN_PASSWORD = 'colind2025';
    
    if (!deletePassword) {
      alert('Te rog introdu parola!');
      return;
    }
    
    const isAdmin = deletePassword === ADMIN_PASSWORD;
    const isOwner = pin.password && deletePassword === pin.password;
    
    if (!isAdmin && !isOwner) {
      alert('âŒ ParolÄƒ incorectÄƒ!');
      setDeletePassword('');
      return;
    }

    try {
      await window.storage.delete(`colind:${pinId}`, true);
      setPins(prev => prev.filter(p => p.id !== pinId));
      setSelectedPin(null);
      setShowDeleteForm(false);
      setDeletePassword('');
    } catch (error) {
      console.error('Delete error:', error);
      alert('Eroare la È™tergere: ' + error.message);
    }
  };

  const cancelForm = () => {
    setShowForm(false);
    setClickedLocation(null);
    setErrorMessage('');
    setNewPin({
      name: '',
      address: '',
      streetNumber: '',
      schedule: '',
      notes: '',
      icon: 'ğŸ„',
      password: ''
    });
  };

  return (
    <div className="h-screen w-full flex flex-col bg-gradient-to-br from-red-50 to-green-50">
      <div className="bg-gradient-to-r from-red-600 to-green-600 text-white p-4 shadow-lg">
        <div className="max-w-7xl mx-auto flex items-center justify-between flex-wrap gap-2">
          <div className="flex items-center gap-3">
            <MapPin className="w-8 h-8" />
            <div>
              <h1 className="text-2xl font-bold">ColindÄƒtori Bine VeniÈ›i ğŸ„</h1>
              <p className="text-sm opacity-90">Cartier Tineri, Buftea - Click pe hartÄƒ sÄƒ adaugi casa!</p>
            </div>
          </div>
          <div className="bg-white/20 px-4 py-2 rounded-full">
            <span className="font-semibold">{pins.length} {pins.length === 1 ? 'casÄƒ' : 'case'}</span>
          </div>
        </div>
      </div>

      <div className="bg-yellow-50 border-b-2 border-yellow-200 px-4 py-3">
        <div className="max-w-7xl mx-auto flex items-start gap-3">
          <AlertCircle className="w-5 h-5 text-yellow-600 flex-shrink-0 mt-0.5" />
          <div className="text-sm text-yellow-800">
            <strong>Cum adaugi casa ta:</strong> Click pe hartÄƒ Ã®n locaÈ›ia casei tale â†’ CompleteazÄƒ formularul â†’ ApasÄƒ "AdaugÄƒ pe HartÄƒ"
          </div>
        </div>
      </div>

      <div className="flex-1 relative">
        <div ref={mapRef} className="w-full h-full" />

        {!showForm && !selectedPin && (
          <button
            onClick={() => {
              setClickedLocation({ lat: 44.545593, lng: 25.931531 });
              setShowForm(true);
            }}
            className="absolute top-4 right-4 bg-gradient-to-r from-red-600 to-green-600 text-white px-6 py-3 rounded-full shadow-2xl hover:shadow-3xl transition-all flex items-center gap-2 font-semibold hover:scale-105"
            style={{zIndex: 9999}}
          >
            <Plus className="w-5 h-5" />
            AdaugÄƒ Casa Mea
          </button>
        )}

        {showForm && (
          <div className="absolute top-4 right-4 bg-white rounded-lg shadow-2xl p-6 w-96 max-h-[calc(100vh-180px)] overflow-y-auto border-2 border-red-300" style={{zIndex: 9999}}>
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                <Plus className="w-6 h-6 text-red-600" />
                AdaugÄƒ Casa Ta
              </h3>
              <button
                onClick={cancelForm}
                className="text-gray-400 hover:text-gray-600 p-1 hover:bg-gray-100 rounded"
              >
                <X className="w-6 h-6" />
              </button>
            </div>

            {clickedLocation && (
              <div className="bg-green-50 border border-green-200 rounded-lg p-3 mb-4">
                <p className="text-sm text-green-800 font-medium">
                  âœ“ LocaÈ›ie selectatÄƒ
                </p>
                <p className="text-xs text-green-600 mt-1">
                  Click pe hartÄƒ pentru a schimba locaÈ›ia exactÄƒ
                </p>
              </div>
            )}

            {errorMessage && (
              <div className="bg-red-50 border border-red-300 rounded-lg p-4 mb-4">
                <div className="flex gap-2">
                  <span className="text-red-600 text-xl flex-shrink-0">âŒ</span>
                  <div>
                    <p className="text-sm font-semibold text-red-800 mb-1">Eroare</p>
                    <p className="text-sm text-red-700 whitespace-pre-line">{errorMessage}</p>
                  </div>
                </div>
                <button
                  onClick={() => setErrorMessage('')}
                  className="mt-2 text-xs text-red-600 hover:text-red-800 font-medium"
                >
                  Ãnchide
                </button>
              </div>
            )}

            <div className="space-y-4">
              <div>
                <label className="text-sm font-medium text-gray-700 mb-2 block">
                  Alege iconiÈ›a ta de CrÄƒciun ğŸ…
                </label>
                <div className="grid grid-cols-4 gap-2">
                  {['ğŸ„', 'ğŸ¬', 'ğŸ…', 'â­', 'ğŸ””', 'ğŸ', 'â„ï¸', 'ğŸ•¯ï¸'].map(emoji => (
                    <button
                      key={emoji}
                      type="button"
                      onClick={() => setNewPin({...newPin, icon: emoji})}
                      className={`text-4xl p-3 rounded-lg transition-all hover:scale-110 ${
                        newPin.icon === emoji 
                          ? 'bg-red-100 border-2 border-red-500 shadow-lg' 
                          : 'bg-gray-50 border-2 border-gray-200 hover:border-red-300'
                      }`}
                    >
                      {emoji}
                    </button>
                  ))}
                </div>
              </div>

              <div>
                <label className="flex items-center gap-2 text-sm font-medium text-gray-700 mb-1">
                  <User className="w-4 h-4" />
                  Nume Familie *
                </label>
                <input
                  type="text"
                  value={newPin.name}
                  onChange={(e) => setNewPin({...newPin, name: e.target.value})}
                  placeholder="Numele familiei"
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
                />
              </div>

              <div>
                <label className="flex items-center gap-2 text-sm font-medium text-gray-700 mb-1">
                  <Home className="w-4 h-4" />
                  Denumire StradÄƒ *
                </label>
                <input
                  type="text"
                  value={newPin.address}
                  onChange={(e) => setNewPin({...newPin, address: e.target.value})}
                  placeholder="Denumire stradÄƒ"
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
                />
              </div>

              <div>
                <label className="text-sm font-medium text-gray-700 mb-1 block">
                  NumÄƒr PoÈ™tal *
                </label>
                <input
                  type="text"
                  value={newPin.streetNumber || ''}
                  onChange={(e) => setNewPin({...newPin, streetNumber: e.target.value})}
                  placeholder="NumÄƒr poÈ™tal"
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
                />
              </div>

              <div>
                <label className="flex items-center gap-2 text-sm font-medium text-gray-700 mb-1">
                  <Clock className="w-4 h-4" />
                  Program preferat
                </label>
                <input
                  type="text"
                  value={newPin.schedule}
                  onChange={(e) => setNewPin({...newPin, schedule: e.target.value})}
                  placeholder="Ex: 24 dec, 18:00-21:00"
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
                />
              </div>

              <div>
                <label className="text-sm font-medium text-gray-700 mb-1 block">
                  Detalii suplimentare
                </label>
                <textarea
                  value={newPin.notes}
                  onChange={(e) => setNewPin({...newPin, notes: e.target.value})}
                  placeholder="Ex: SunaÈ›i la interfon, poartÄƒ verde"
                  rows={3}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
                />
              </div>

              <div>
                <label className="text-sm font-medium text-gray-700 mb-1 block">
                  ParolÄƒ pentru È™tergere (opÈ›ional)
                </label>
                <input
                  type="password"
                  value={newPin.password}
                  onChange={(e) => setNewPin({...newPin, password: e.target.value})}
                  placeholder="SeteazÄƒ o parolÄƒ pentru a putea È™terge pin-ul"
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
                />
                <p className="text-xs text-gray-500 mt-1">
                  ğŸ’¡ Doar tu vei putea È™terge pin-ul cu aceastÄƒ parolÄƒ
                </p>
              </div>

              <button
                type="button"
                onClick={savePin}
                className="w-full bg-gradient-to-r from-red-600 to-green-600 text-white py-3 rounded-lg font-semibold hover:from-red-700 hover:to-green-700 transition-all shadow-lg"
              >
                AdaugÄƒ pe HartÄƒ
              </button>
            </div>
          </div>
        )}

        {selectedPin && !showForm && (
          <div className="absolute bottom-4 left-4 bg-white rounded-lg shadow-2xl p-6 w-96 border-2 border-green-300" style={{zIndex: 9999}}>
            {!showDeleteForm ? (
              <>
                <div className="flex items-start justify-between mb-3">
                  <div>
                    <h3 className="text-xl font-bold text-gray-800">{selectedPin.name}</h3>
                    <p className="text-gray-600 flex items-center gap-2 mt-1">
                      <Home className="w-4 h-4" />
                      Str. {selectedPin.address}, Nr. {selectedPin.streetNumber}
                    </p>
                  </div>
                  <div className="flex gap-2">
                    <button
                      onClick={() => setShowDeleteForm(true)}
                      className="text-red-600 hover:bg-red-50 p-2 rounded-lg transition-colors"
                      title="È˜terge"
                    >
                      <Trash2 className="w-5 h-5" />
                    </button>
                    <button
                      onClick={() => setSelectedPin(null)}
                      className="text-gray-400 hover:text-gray-600 p-1 hover:bg-gray-100 rounded"
                    >
                      <X className="w-6 h-6" />
                    </button>
                  </div>
                </div>

                {selectedPin.schedule && (
                  <div className="flex items-center gap-2 text-gray-700 mb-2">
                    <Clock className="w-4 h-4 text-red-600" />
                    <span className="text-sm font-medium">{selectedPin.schedule}</span>
                  </div>
                )}

                {selectedPin.notes && (
                  <div className="mt-3 pt-3 border-t border-gray-200">
                    <p className="text-sm text-gray-600">{selectedPin.notes}</p>
                  </div>
                )}
              </>
            ) : (
              <div>
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-lg font-bold text-red-600">È˜terge Pin</h3>
                  <button
                    onClick={() => {
                      setShowDeleteForm(false);
                      setDeletePassword('');
                    }}
                    className="text-gray-400 hover:text-gray-600"
                  >
                    <X className="w-5 h-5" />
                  </button>
                </div>
                
                <div className="space-y-4">
                  <div>
                    <label className="text-sm font-medium text-gray-700 mb-2 block">
                      Introdu parola:
                    </label>
                    <input
                      type="password"
                      value={deletePassword}
                      onChange={(e) => setDeletePassword(e.target.value)}
                      placeholder="Parola de È™tergere"
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
                      onKeyPress={(e) => {
                        if (e.key === 'Enter') {
                          deletePin(selectedPin.id);
                        }
                      }}
                    />
                    <p className="text-xs text-gray-500 mt-1">
                      ğŸ’¡ Introdu parola ta dacÄƒ ai setat-o, sau cere adminului sÄƒ o È™teargÄƒ pentru tine
                    </p>
                  </div>
                  
                  <div className="flex gap-2">
                    <button
                      onClick={() => deletePin(selectedPin.id)}
                      className="flex-1 bg-red-600 text-white py-2 rounded-lg font-semibold hover:bg-red-700 transition-colors"
                    >
                      È˜terge Pin
                    </button>
                    <button
                      onClick={() => {
                        setShowDeleteForm(false);
                        setDeletePassword('');
                      }}
                      className="flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg font-semibold hover:bg-gray-300 transition-colors"
                    >
                      AnuleazÄƒ
                    </button>
                  </div>
                </div>
              </div>
            )}
          </div>
        )}

        {loading && (
          <div className="absolute inset-0 bg-white/90 flex items-center justify-center" style={{zIndex: 9999}}>
            <div className="text-center">
              <div className="animate-spin rounded-full h-12 w-12 border-4 border-red-600 border-t-transparent mx-auto mb-4"></div>
              <p className="text-gray-600 font-medium">Se Ã®ncarcÄƒ harta...</p>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}
