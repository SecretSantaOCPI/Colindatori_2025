<script>
    // ConfiguraÈ›ie Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyD4j5pOuXalnS-TErmivkJEa-4ki5e_x6s",
        authDomain: "colindatori-buftea.firebaseapp.com",
        databaseURL: "https://colindatori-buftea-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "colindatori-buftea",
        storageBucket: "colindatori-buftea.firebasestorage.app",
        messagingSenderId: "386078081254",
        appId: "1:386078081254:web:8625f492e1a110fa257b27"
    };
    
    const ADMIN_PASSWORD = 'colind2025';
    const ICONS = ['ğŸ„', 'ğŸ…', 'â­', 'ğŸ””', 'ğŸ', 'â„ï¸', 'ğŸ•¯ï¸', 'ğŸ¦Œ', 'ğŸ§¦', 'ğŸª', 'ğŸ¤¶', 'âœ¨'];
    
    // STRÄ‚ZI CORECTATE - Salviei Ã®n loc de Salbiei
    const PREDEFINED_STREETS = [
        "Catinei", "Ciocarliei", "Codrului", "Dafinului", "Dropiei", 
        "Frasinului", "Gutuiului", "Lujerului", "Macesului", "Magnoliei",
        "Mesteacanului", "Nuferilor", "Porumbacului", "Salviei", "Salciei",
        "Trestiei", "Trifoiului", "Ulmului"
    ].sort();
    
    const ZONE_BOUNDS = [
        [44.548509, 25.932824], [44.545532, 25.927008],  
        [44.542515, 25.930210], [44.545553, 25.935854]
    ];
    
    const CARTIER_CENTER = [44.545593, 25.931531];
    
    let map;
    let markers = [];
    let pins = [];
    let selectedIcon = 'ğŸ„';
    let clickedLocation = null;
    let selectedPin = null;
    let isConnected = false;
    let userLocationMarker = null;
    let zonePolygon = null;
    let isAdmin = false;
    let visitedHouses = JSON.parse(localStorage.getItem('visitedHouses') || '{}');
    
    document.addEventListener('DOMContentLoaded', init);
    
    function init() {
        initFirebase();
        initMap();
        initIconGrid();
        initStreetInput();
        setupEventListeners();
    }
    
    function setupEventListeners() {
        document.getElementById('add-btn-right').addEventListener('click', openAddModal);
        document.getElementById('gps-btn').addEventListener('click', getUserLocation);
        document.getElementById('center-btn').addEventListener('click', centerToCartier);
        document.getElementById('share-btn-right').addEventListener('click', shareOnWhatsApp);
        document.getElementById('pin-count').addEventListener('click', showListModal);
        document.getElementById('modal-overlay').addEventListener('click', closeAllModals);
    }
    
    // === FUNCÈšIE SHARE WHATSAPP ===
    function shareOnWhatsApp() {
        const text = 'ğŸ„ Colindatori Bine Veniti! ğŸ…\n\nHarta caselor care primesc colindatori.\nAdauga si casa ta: ' + window.location.href;
        
        // FoloseÈ™te API-ul nativ de share dacÄƒ e disponibil (pe mobil)
        if (navigator.share) {
            navigator.share({
                title: 'Colindatori Buftea',
                text: text
            }).catch(err => console.log('Share error:', err));
        } else {
            // Fallback pentru desktop
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(text)}`;
            window.open(whatsappUrl, '_blank');
        }
    }
    
    function centerToCartier() {
        map.setView(CARTIER_CENTER, 17);
        showToast('ğŸ  Centrat pe Cartierul Tineri');
    }
    
    // === VERIFICARE ZONÄ‚ ===
    function isInZone(lat, lng) {
        let inside = false;
        for (let i = 0, j = ZONE_BOUNDS.length - 1; i < ZONE_BOUNDS.length; j = i++) {
            const xi = ZONE_BOUNDS[i][1], yi = ZONE_BOUNDS[i][0];
            const xj = ZONE_BOUNDS[j][1], yj = ZONE_BOUNDS[j][0];
            
            const intersect = ((yi > lat) !== (yj > lat)) &&
                (lng < (xj - xi) * (lat - yi) / (yj - yi) + xi);
            if (intersect) inside = !inside;
        }
        return inside;
    }
    
    function initMap() {
        map = L.map('map').setView(CARTIER_CENTER, 17);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);
        
        // AdaugÄƒ poligonul zonei
        zonePolygon = L.polygon(ZONE_BOUNDS, {
            color: '#dc2626',
            weight: 3,
            fillColor: '#fecaca',
            fillOpacity: 0.2,
            opacity: 0.8
        }).addTo(map);
        
        // AdaugÄƒ tooltip la poligon
        zonePolygon.bindTooltip('ğŸ„ Cartierul Tineri - Zona ColindÄƒtori', {
            permanent: false,
            direction: 'center',
            className: 'zone-tooltip'
        });
        
        map.on('click', (e) => {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;
            
            // VerificÄƒ dacÄƒ click-ul este Ã®n zonÄƒ
            if (!isInZone(lat, lng)) {
                showToast('âŒ PoÈ›i adÄƒuga doar case din Cartierul Tineri!', 'error');
                return;
            }
            
            clickedLocation = { lat, lng };
            
            if (window.tempMarker) {
                window.tempMarker.remove();
            }
            
            window.tempMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    html: '<div style="font-size: 48px; animation: pulse 1s infinite; filter: drop-shadow(0 3px 6px rgba(0,0,0,0.4));">ğŸ“</div>',
                    className: 'temp-marker',
                    iconSize: [48, 48],
                    iconAnchor: [24, 48]
                })
            }).addTo(map);
            
            if (!document.getElementById('add-modal').classList.contains('hidden')) {
                document.getElementById('location-success').classList.remove('hidden');
            }
        });
        
        setTimeout(() => {
            map.invalidateSize();
            document.getElementById('loading').classList.add('hidden');
        }, 300);
        
        window.addEventListener('resize', () => {
            setTimeout(() => {
                map.invalidateSize();
            }, 100);
        });
    }
    
    function initIconGrid() {
        const grid = document.getElementById('icon-grid');
        grid.innerHTML = '';
        ICONS.forEach(icon => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'icon-btn';
            btn.textContent = icon;
            btn.onclick = () => selectIcon(icon);
            if (icon === selectedIcon) btn.classList.add('selected');
            grid.appendChild(btn);
        });
    }
    
    function initStreetInput() {
        const container = document.getElementById('street-container');
        container.innerHTML = '';
        
        const datalist = document.createElement('datalist');
        datalist.id = 'streets-list';
        
        PREDEFINED_STREETS.forEach(street => {
            const option = document.createElement('option');
            option.value = street;
            datalist.appendChild(option);
        });
        
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'street-input';
        input.id = 'address';
        input.placeholder = 'Ãncepe sÄƒ tastezi numele strÄƒzii...';
        input.setAttribute('list', 'streets-list');
        input.required = true;
        input.autocomplete = 'off';
        
        input.addEventListener('change', function() {
            validateStreetInput(this);
        });
        
        container.appendChild(input);
        container.appendChild(datalist);
    }
    
    function validateStreetInput(inputElement) {
        const value = inputElement.value.trim();
        if (value && !PREDEFINED_STREETS.includes(value)) {
            showToast('âš ï¸ Strada nu se aflÄƒ Ã®n lista strÄƒzilor din Cartierul Tineri. VerificÄƒ dacÄƒ ai scris corect.', 'error');
        }
    }
    
    function selectIcon(icon) {
        selectedIcon = icon;
        document.querySelectorAll('.icon-btn').forEach(btn => {
            btn.classList.toggle('selected', btn.textContent === icon);
        });
    }
    
    function initFirebase() {
        try {
            firebase.initializeApp(firebaseConfig);
            const database = firebase.database();
            
            const connectedRef = database.ref(".info/connected");
            connectedRef.on("value", function(snap) {
                isConnected = snap.val() === true;
                updateConnectionStatus();
            });
            
            loadPins();
        } catch (error) {
            console.error("Eroare la iniÈ›ializarea Firebase:", error);
            showToast("Eroare de conexiune cu baza de date", "error");
        }
    }
    
    function updateConnectionStatus() {
        const statusElement = document.getElementById('connection-status');
        
        if (isConnected) {
            statusElement.className = 'connection-status connected';
        } else {
            statusElement.className = 'connection-status disconnected';
        }
    }
    
    function loadPins() {
        try {
            const database = firebase.database();
            database.ref('pins').on('value', (snapshot) => {
                pins = [];
                snapshot.forEach((child) => {
                    pins.push({ id: child.key, ...child.val() });
                });
                updateMap();
                updatePinCount();
            }, (error) => {
                console.error("Eroare la Ã®ncÄƒrcarea pin-urilor:", error);
                showToast("Eroare la Ã®ncÄƒrcarea datelor", "error");
            });
        } catch (error) {
            console.error("Eroare la Ã®ncÄƒrcarea pin-urilor:", error);
            showToast("Eroare la Ã®ncÄƒrcarea datelor", "error");
        }
    }
    
    function updateMap() {
        markers.forEach(marker => marker.remove());
        markers = [];
        
        pins.forEach(pin => {
            const isVisited = visitedHouses[pin.id];
            const icon = pin.icon || 'ğŸ„';
            
            // CreeazÄƒ marker-ul cu stil diferit pentru casele vizitate
            const marker = L.marker([pin.lat, pin.lng], {
                icon: L.divIcon({
                    html: `
                        <div class="${isVisited ? 'visited-marker' : ''}" style="font-size: 42px; filter: drop-shadow(0 3px 6px rgba(0,0,0,0.4)); transform: translateY(-5px); position: relative;">
                            ${icon}
                        </div>
                    `,
                    className: 'custom-marker',
                    iconSize: [42, 42],
                    iconAnchor: [21, 42]
                })
            }).addTo(map);
            
            // Tooltip detaliat cu toate informaÈ›iile È™i butoane de acÈ›iune
            let tooltipContent = `
                <div class="custom-tooltip">
                    <div class="tooltip-family">
                        ${isVisited ? 'âœ… ' : ''}${pin.icon || 'ğŸ„'} ${pin.name}
                        ${isVisited ? '<span style="color: #059669; font-size: 12px;">(VizitatÄƒ)</span>' : ''}
                    </div>
                    <div class="tooltip-address">
                        ğŸ“ Str. ${pin.address}, Nr. ${pin.streetNumber}
                    </div>
            `;
            
            if (pin.schedule) {
                tooltipContent += `
                    <div class="tooltip-schedule">
                        ğŸ• ${pin.schedule}
                    </div>
                `;
            }
            
            if (pin.notes) {
                tooltipContent += `
                    <div class="tooltip-notes">
                        ğŸ“ ${pin.notes}
                    </div>
                `;
            }
            
            // SECÈšIUNE ACÈšIUNI - pentru toÈ›i utilizatorii
            tooltipContent += `
                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e5e7eb; display: flex; flex-direction: column; gap: 5px;">
                    <button onclick="window.tooltipToggleVisited('${pin.id}')" 
                            style="background: #10b981; color: white; border: none; padding: 6px 10px; border-radius: 6px; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px;">
                        ${isVisited ? 'âŒ MarcheazÄƒ nevizitatÄƒ' : 'âœ… MarcheazÄƒ vizitatÄƒ'}
                    </button>
            `;
            
            // Buton de È™tergere pentru admin SAU proprietari
            const userIsOwner = pin.password && pin.password.length > 0;
            if (isAdmin || userIsOwner) {
                tooltipContent += `
                    <button onclick="window.tooltipShowPin('${pin.id}')" 
                            style="background: #dc2626; color: white; border: none; padding: 6px 10px; border-radius: 6px; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px;">
                        ğŸ—‘ï¸ ${isAdmin ? 'È˜terge (Admin)' : 'È˜terge (Mea)'}
                    </button>
                `;
            }
            
            tooltipContent += `</div></div>`;
            
            marker.bindTooltip(tooltipContent, {
                direction: 'top',
                offset: [0, -40],
                opacity: 0.95,
                className: 'custom-tooltip-container'
            });
            
            // Click simplu pe marker â†’ bifeazÄƒ (comportament principal)
            marker.on('click', () => {
                toggleVisited(pin.id);
            });
            
            // Click dreapta pentru admini (doar pe desktop)
            marker.on('contextmenu', (e) => {
                if (isAdmin) {
                    e.originalEvent.preventDefault();
                    showPin(pin);
                }
            });
            
            markers.push(marker);
        });
    }
    
    // FuncÈ›ii globale pentru butoanele din tooltip
    window.tooltipToggleVisited = function(houseId) {
        toggleVisited(houseId);
        // ReÃ®ncarcÄƒ tooltip-ul
        updateMap();
    };
    
    window.tooltipShowPin = function(houseId) {
        const pin = pins.find(p => p.id === houseId);
        if (pin) {
            showPin(pin);
        }
    };
    
    function updatePinCount() {
        const count = pins.length;
        const visitedCount = Object.keys(visitedHouses).length;
        const text = count === 1 ? 'casÄƒ' : 'case';
        const visitedText = visitedCount > 0 ? ` (${visitedCount} vizitate)` : '';
        document.getElementById('pin-count-text').textContent = `${count} ${text}${visitedText}`;
    }
    
    function showError(message) {
        document.getElementById('error-text').textContent = message;
        document.getElementById('error-message').classList.remove('hidden');
    }
    
    function closeError() {
        document.getElementById('error-message').classList.add('hidden');
    }
    
    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }
    
    function openAddModal() {
        if (!clickedLocation) {
            showToast('âš ï¸ Mai Ã®ntÃ¢i selecteazÄƒ o locaÈ›ie pe hartÄƒ sau foloseÈ™te butonul GPS!', 'error');
            return;
        }
        showModal('add-modal');
        initStreetInput();
    }
    
    function closeAddModal() {
        hideModal('add-modal');
        document.getElementById('add-form').reset();
        document.getElementById('error-message').classList.add('hidden');
        clickedLocation = null;
        selectedIcon = 'ğŸ„';
        initIconGrid();
        initStreetInput();
        
        if (window.tempMarker) {
            window.tempMarker.remove();
            window.tempMarker = null;
        }
    }
    
    function showModal(modalId) {
        document.getElementById(modalId).classList.remove('hidden');
        document.getElementById('modal-overlay').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }
    
    function hideModal(modalId) {
        document.getElementById(modalId).classList.add('hidden');
        document.getElementById('modal-overlay').classList.add('hidden');
        document.body.style.overflow = '';
    }
    
    function closeAllModals() {
        hideModal('add-modal');
        hideModal('view-modal');
        hideModal('list-modal');
        hideModal('admin-login-modal');
    }
    
    // === SISTEM TRACKING VIZITE ===
    function toggleVisited(houseId) {
        // FÄƒrÄƒ restricÈ›ie de admin - toatÄƒ lumea poate bifa
        if (visitedHouses[houseId]) {
            delete visitedHouses[houseId];
            showToast('âœ… CasÄƒ marcatÄƒ ca nevizitatÄƒ');
        } else {
            visitedHouses[houseId] = true;
            showToast('âœ… CasÄƒ marcatÄƒ ca vizitatÄƒ');
        }
        
        localStorage.setItem('visitedHouses', JSON.stringify(visitedHouses));
        updateMap(); // ActualizeazÄƒ direct harta
        updatePinCount();
        
        // ActualizeazÄƒ lista dacÄƒ este deschisÄƒ
        if (!document.getElementById('list-modal').classList.contains('hidden')) {
            showListModal();
        }
    }
    
    function resetAllVisited() {
        // PÄ‚STRAT doar pentru reset (doar admin)
        if (!isAdmin) {
            showToast('âŒ Nu ai permisiunea de a reseta vizitele!', 'error');
            return;
        }
        
        visitedHouses = {};
        localStorage.setItem('visitedHouses', JSON.stringify(visitedHouses));
        updateMap();
        updatePinCount();
        
        if (!document.getElementById('list-modal').classList.contains('hidden')) {
            showListModal();
        }
        
        showToast('âœ… Toate vizitele au fost resetate!', 'success');
    }
    
    // === SISTEM ADMIN ===
    function showAdminLogin() {
        showModal('admin-login-modal');
    }
    
    function closeAdminLogin() {
        hideModal('admin-login-modal');
        document.getElementById('admin-password').value = '';
    }
    
    function verifyAdmin() {
        const password = document.getElementById('admin-password').value;
        
        if (password === ADMIN_PASSWORD) {
            isAdmin = true;
            document.getElementById('reset-btn').disabled = false;
            closeAdminLogin();
            showToast('âœ… Login admin reuÈ™it!', 'success');
            
            // ReÃ®ncarcÄƒ harta cu butoanele de admin
            updateMap();
            
            // ReÃ®ncarcÄƒ lista dacÄƒ este deschisÄƒ
            if (!document.getElementById('list-modal').classList.contains('hidden')) {
                showListModal();
            }
        } else {
            showToast('âŒ ParolÄƒ incorectÄƒ!', 'error');
        }
    }
    
    // === MODAL LISTA CASE ===
    function showListModal() {
        if (pins.length === 0) {
            showToast('ğŸ“­ Nu existÄƒ case Ã®ncÄƒ adÄƒugate!', 'error');
            return;
        }
        
        // SorteazÄƒ casele dupÄƒ stradÄƒ È™i numÄƒr
        const sortedPins = [...pins].sort((a, b) => {
            const streetCompare = a.address.localeCompare(b.address);
            if (streetCompare !== 0) return streetCompare;
            return a.streetNumber.localeCompare(b.streetNumber);
        });
        
        const listContainer = document.getElementById('list-container');
        listContainer.innerHTML = '';
        
        if (sortedPins.length === 0) {
            listContainer.innerHTML = `
                <div class="empty-list">
                    <p>ğŸ“­ Nu existÄƒ case Ã®ncÄƒ adÄƒugate!</p>
                    <p style="margin-top: 0.5rem; font-size: 0.875rem;">Fii primul care adaugÄƒ casa!</p>
                </div>
            `;
        } else {
            sortedPins.forEach(pin => {
                const isVisited = visitedHouses[pin.id];
                const listItem = document.createElement('div');
                listItem.className = `list-item ${isVisited ? 'visited' : ''}`;
                
                // Checkbox-ul apare pentru toÈ›i
                const adminControls = `
                    <div class="checkbox-container">
                        <div class="checkbox ${isVisited ? 'checked' : ''}" onclick="toggleVisited('${pin.id}')"></div>
                        <span class="checkbox-label" onclick="toggleVisited('${pin.id}')">Am colindat aici</span>
                    </div>
                `;
                
                listItem.innerHTML = `
                    <div class="list-icon">${isVisited ? 'âœ…' : (pin.icon || 'ğŸ„')}</div>
                    <div class="list-details">
                        <div class="list-family">${pin.name} ${isVisited ? '<span style="color: #059669; font-size: 12px;">(VizitatÄƒ)</span>' : ''}</div>
                        <div class="list-address">Str. ${pin.address}, Nr. ${pin.streetNumber}</div>
                        ${pin.schedule ? `<div class="list-schedule">ğŸ• ${pin.schedule}</div>` : ''}
                        ${pin.notes ? `<div class="list-notes">ğŸ“ ${pin.notes}</div>` : ''}
                        ${adminControls}
                    </div>
                `;
                listContainer.appendChild(listItem);
            });
        }
        
        showModal('list-modal');
    }
    
    function closeListModal() {
        hideModal('list-modal');
    }
    
    function showPin(pin) {
        selectedPin = pin;
        const isVisited = visitedHouses[pin.id];
        const addressText = `Str. ${pin.address}, Nr. ${pin.streetNumber}`;
        const userIsOwner = pin.password && pin.password.length > 0;
        
        let html = `
            <div class="modal-header">
                <div>
                    <h3 class="modal-title">${pin.name} ${isVisited ? 'âœ…' : ''}</h3>
                    <p class="pin-detail">
                        <span>${isVisited ? 'âœ…' : (pin.icon || 'ğŸ„')}</span>
                        <span class="pin-info">${addressText}</span>
                    </p>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    ${(isAdmin || userIsOwner) ? '<button class="icon-delete" onclick="showDeleteForm()">ğŸ—‘ï¸</button>' : ''}
                    <button class="close-btn" onclick="closeViewModal()">Ã—</button>
                </div>
            </div>
        `;
        
        if (pin.schedule) {
            html += `<div class="pin-schedule">
                <strong>ğŸ• Program preferat:</strong><br>
                ${pin.schedule}
            </div>`;
        }
        
        if (pin.notes) {
            html += `<div class="pin-notes">
                <strong>ğŸ“ Detalii:</strong><br>
                ${pin.notes}
            </div>`;
        }
        
        // Buton de marcare pentru toÈ›i
        html += `
            <div class="checkbox-container" style="margin: 1rem 1.25rem;">
                <div class="checkbox ${isVisited ? 'checked' : ''}" onclick="toggleVisited('${pin.id}')"></div>
                <span class="checkbox-label" onclick="toggleVisited('${pin.id}')">Am colindat la aceastÄƒ casÄƒ</span>
            </div>
        `;
        
        // Mesaj informativ pentru È™tergere
        if (userIsOwner && !isAdmin) {
            html += `
                <div style="background: #fef3c7; border: 1px solid #fcd34d; border-radius: 0.5rem; padding: 0.75rem; margin: 0 1.25rem;">
                    <p style="font-size: 0.875rem; color: #92400e; margin: 0;">
                        ğŸ’¡ PoÈ›i È™terge aceastÄƒ casÄƒ folosind parola pe care ai setat-o.
                    </p>
                </div>
            `;
        }
        
        document.getElementById('view-content').innerHTML = html;
        showModal('view-modal');
        document.getElementById('delete-form').classList.add('hidden');
    }
    
    function closeViewModal() {
        hideModal('view-modal');
        selectedPin = null;
        document.getElementById('view-content').style.display = 'block';
        document.getElementById('delete-form').classList.add('hidden');
    }
    
    function showDeleteForm() {
        document.getElementById('view-content').style.display = 'none';
        document.getElementById('delete-form').classList.remove('hidden');
    }
    
    function closeDeleteForm() {
        document.getElementById('view-content').style.display = 'block';
        document.getElementById('delete-form').classList.add('hidden');
        document.getElementById('delete-password').value = '';
    }
    
    function confirmDelete() {
        if (!selectedPin) return;
        
        const password = document.getElementById('delete-password').value;
        
        if (!password) {
            showToast('Te rog introdu parola!', 'error');
            return;
        }
        
        const isAdminUser = password === ADMIN_PASSWORD;
        const isOwner = selectedPin.password && password === selectedPin.password;
        
        if (!isAdminUser && !isOwner) {
            showToast('âŒ ParolÄƒ incorectÄƒ!', 'error');
            document.getElementById('delete-password').value = '';
            return;
        }
        
        try {
            const database = firebase.database();
            database.ref('pins/' + selectedPin.id).remove()
                .then(() => {
                    closeViewModal();
                    showToast('âœ… Pin È™ters cu succes!');
                })
                .catch((error) => {
                    console.error('Delete error:', error);
                    showToast('Eroare la È™tergere: ' + error.message, 'error');
                });
        } catch (error) {
            console.error('Delete error:', error);
            showToast('Eroare la È™tergere: ' + error.message, 'error');
        }
    }
    
    function handleSubmit(e) {
        e.preventDefault();
        
        closeError();
        
        const name = document.getElementById('name').value.trim();
        const address = document.getElementById('address').value.trim();
        const streetNumber = document.getElementById('streetNumber').value.trim();
        
        const missingFields = [];
        if (!name) missingFields.push('Nume Familie');
        if (!address) missingFields.push('StradÄƒ');
        if (!streetNumber) missingFields.push('NumÄƒr PoÈ™tal');
        
        if (missingFields.length > 0) {
            showError('Te rog completeazÄƒ urmÄƒtoarele cÃ¢mpuri obligatorii:\n\nâ€¢ ' + missingFields.join('\nâ€¢ '));
            return;
        }
        
        if (!clickedLocation) {
            showError('Te rog selecteazÄƒ o locaÈ›ie pe hartÄƒ sau foloseÈ™te GPS-ul!');
            return;
        }
        
        // === VERIFICARE ZONÄ‚ LA SUBMIT ===
        if (!isInZone(clickedLocation.lat, clickedLocation.lng)) {
            showError('âŒ PoÈ›i adÄƒuga doar case din Cartierul Tineri!\n\nSelecteazÄƒ o locaÈ›ie Ã®n interiorul zonei marcate cu roÈ™u.');
            return;
        }
        
        if (!isConnected) {
            showError('Nu eÈ™ti conectat la internet. Te rog verificÄƒ conexiunea È™i Ã®ncearcÄƒ din nou.');
            return;
        }
        
        const pinData = {
            name,
            address,
            streetNumber,
            schedule: document.getElementById('schedule').value,
            notes: document.getElementById('notes').value,
            icon: selectedIcon,
            password: document.getElementById('password').value,
            lat: clickedLocation.lat,
            lng: clickedLocation.lng,
            timestamp: new Date().toISOString()
        };
        
        try {
            const database = firebase.database();
            database.ref('pins').push(pinData)
                .then(() => {
                    closeAddModal();
                    
                    if (window.tempMarker) {
                        window.tempMarker.remove();
                        window.tempMarker = null;
                    }
                    
                    showToast('âœ… CasÄƒ adÄƒugatÄƒ cu succes!');
                })
                .catch((error) => {
                    console.error('Save error:', error);
                    showError('Eroare la salvare: ' + error.message);
                });
        } catch (error) {
            console.error('Save error:', error);
            showError('Eroare la salvare: ' + error.message);
        }
    }
    
    function getUserLocation() {
        const gpsBtn = document.getElementById('gps-btn');
        gpsBtn.disabled = true;
        gpsBtn.classList.add('loading');
        gpsBtn.innerHTML = 'â³';
        
        if (!navigator.geolocation) {
            showToast('GeolocaÈ›ia nu este suportatÄƒ de browser-ul tÄƒu', 'error');
            resetGpsButton();
            return;
        }
        
        navigator.geolocation.getCurrentPosition(
            function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                const accuracy = position.coords.accuracy;
                
                // VerificÄƒ dacÄƒ locaÈ›ia este Ã®n zonÄƒ
                if (!isInZone(lat, lng)) {
                    showToast('âŒ EÈ™ti Ã®n afara Cartierului Tineri! FoloseÈ™te click pe hartÄƒ.', 'error');
                    resetGpsButton();
                    return;
                }
                
                clickedLocation = { lat, lng };
                
                if (userLocationMarker) {
                    userLocationMarker.remove();
                }
                
                userLocationMarker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        html: '<div style="font-size: 48px; animation: pulse 1s infinite; filter: drop-shadow(0 3px 6px rgba(0,0,0,0.4)); color: #3b82f6;">ğŸ“</div>',
                        className: 'user-location-marker',
                        iconSize: [48, 48],
                        iconAnchor: [24, 48]
                    })
                }).addTo(map);
                
                map.setView([lat, lng], 17);
                
                showToast(`âœ… LocaÈ›ie gÄƒsitÄƒ! Precizie: ${Math.round(accuracy)} metri`, 'success');
                
                gpsBtn.innerHTML = 'âœ…';
                setTimeout(resetGpsButton, 2000);
                
                if (!document.getElementById('add-modal').classList.contains('hidden')) {
                    document.getElementById('location-success').classList.remove('hidden');
                }
            },
            function(error) {
                let errorMessage = 'Eroare la obÈ›inerea locaÈ›iei: ';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage += 'Ai refuzat accesul la locaÈ›ie.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage += 'LocaÈ›ia nu este disponibilÄƒ.';
                        break;
                    case error.TIMEOUT:
                        errorMessage += 'Timeout la obÈ›inerea locaÈ›iei.';
                        break;
                    default:
                        errorMessage += 'Eroare necunoscutÄƒ.';
                        break;
                }
                showToast(errorMessage, 'error');
                resetGpsButton();
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000
            }
        );
    }
    
    function resetGpsButton() {
        const gpsBtn = document.getElementById('gps-btn');
        gpsBtn.disabled = false;
        gpsBtn.classList.remove('loading');
        gpsBtn.innerHTML = 'ğŸ“';
    }
</script>
