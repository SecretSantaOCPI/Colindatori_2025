<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ColindÄƒtori Bine VeniÈ›i - Cartier Tineri Buftea</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<style>
/* PÄƒstreazÄƒ CSS-ul tÄƒu original aici */
</style>
</head>
<body>
<div id="header">
  <div id="header-content">
    <div id="header-title">
      <span style="font-size: 2rem;">ğŸ“</span>
      <div>
        <h1>ColindÄƒtori Bine VeniÈ›i ğŸ„</h1>
        <p>Cartier Tineri, Buftea - Click pe hartÄƒ sÄƒ adaugi casa!</p>
      </div>
    </div>
    <div id="pin-count">
      <span id="pin-count-text">0 case</span>
    </div>
  </div>
</div>

<div id="instructions">
  <div id="instructions-content">
    <span>âš ï¸</span>
    <div>
      <strong>Cum adaugi casa ta:</strong> Click pe hartÄƒ Ã®n locaÈ›ia casei tale â†’ CompleteazÄƒ formularul â†’ ApasÄƒ "AdaugÄƒ pe HartÄƒ"
    </div>
  </div>
</div>

<div id="map-container">
  <div id="map"></div>
  <button id="add-btn" class="btn btn-primary" style="position: absolute; top: 1rem; right: 1rem; z-index: 9999;">
    <span style="font-size: 1.25rem;">+</span> AdaugÄƒ Casa Mea
  </button>

  <!-- Modal AdaugÄƒ -->
  <div id="add-modal" class="modal modal-add hidden">
    <div class="modal-header">
      <h3 class="modal-title"><span style="font-size:1.5rem;">+</span> AdaugÄƒ Casa Ta</h3>
      <button class="close-btn" onclick="closeAddModal()">Ã—</button>
    </div>
    <div id="location-success" class="success-box hidden">
      <p class="success-text">âœ“ LocaÈ›ie selectatÄƒ</p>
      <p class="hint-text">Click pe hartÄƒ pentru a schimba locaÈ›ia exactÄƒ</p>
    </div>
    <div id="error-message" class="error-box hidden">
      <div style="display:flex;gap:0.5rem;">
        <span style="font-size:1.25rem;">âŒ</span>
        <div style="flex:1;">
          <p class="error-text" style="font-weight:600;margin-bottom:0.25rem;">Eroare</p>
          <p class="error-text" id="error-text" style="white-space:pre-line;"></p>
        </div>
      </div>
      <button onclick="closeError()" style="margin-top:0.5rem;font-size:0.75rem;color:#991b1b;background:none;border:none;cursor:pointer;font-weight:500;">Ãnchide</button>
    </div>
    <form id="add-form" onsubmit="handleSubmit(event)">
      <div class="form-group">
        <label class="form-label">Alege iconiÈ›a ta de CrÄƒciun ğŸ…</label>
        <div class="icon-grid" id="icon-grid"></div>
      </div>
      <div class="form-group">
        <label class="form-label">ğŸ‘¤ Nume Familie *</label>
        <input type="text" class="form-input" id="name" placeholder="Numele familiei">
      </div>
      <div class="form-group">
        <label class="form-label">ğŸ  Denumire StradÄƒ *</label>
        <input type="text" class="form-input" id="address" placeholder="Denumire stradÄƒ">
      </div>
      <div class="form-group">
        <label class="form-label">NumÄƒr PoÈ™tal *</label>
        <input type="text" class="form-input" id="streetNumber" placeholder="NumÄƒr poÈ™tal">
      </div>
      <div class="form-group">
        <label class="form-label">ğŸ• Program preferat</label>
        <input type="text" class="form-input" id="schedule" placeholder="Ex: 24 dec, 18:00-21:00">
      </div>
      <div class="form-group">
        <label class="form-label">Detalii suplimentare</label>
        <textarea class="form-textarea" id="notes" rows="3" placeholder="Ex: SunaÈ›i la interfon, poartÄƒ verde"></textarea>
      </div>
      <div class="form-group">
        <label class="form-label">ParolÄƒ pentru È™tergere (opÈ›ional)</label>
        <input type="password" class="form-input" id="password" placeholder="SeteazÄƒ o parolÄƒ">
        <p class="hint-text">ğŸ’¡ Doar tu vei putea È™terge pin-ul cu aceastÄƒ parolÄƒ</p>
      </div>
      <div style="height:120px;"></div>
      <div class="submit-btn-container">
        <button type="submit" class="btn btn-primary" style="width:100%;">AdaugÄƒ pe HartÄƒ</button>
      </div>
    </form>
  </div>

  <!-- Modal Vizualizare È™i È˜tergere -->
  <div id="view-modal" class="modal modal-view hidden">
    <div id="view-content"></div>
    <div id="delete-form" class="hidden">
      <div class="modal-header">
        <h3 class="modal-title" style="color:#dc2626;">È˜terge Pin</h3>
        <button class="close-btn" onclick="closeDeleteForm()">Ã—</button>
      </div>
      <div class="form-group">
        <label class="form-label">Introdu parola:</label>
        <input type="password" class="form-input" id="delete-password" placeholder="Parola de È™tergere">
        <p class="hint-text">ğŸ’¡ Introdu parola ta dacÄƒ ai setat-o, sau cere adminului</p>
      </div>
      <div style="height:80px;"></div>
      <div style="padding-top:1rem;border-top:2px solid #e5e7eb;">
        <div class="action-buttons">
          <button onclick="confirmDelete()" class="btn btn-danger" style="flex:1;">È˜terge Pin</button>
          <button onclick="closeDeleteForm()" class="btn btn-secondary" style="flex:1;">AnuleazÄƒ</button>
        </div>
      </div>
    </div>
  </div>

  <div id="loading">
    <div style="text-align:center;">
      <div class="spinner"></div>
      <p style="margin-top:1rem;color:#6b7280;font-weight:500;">Se Ã®ncarcÄƒ harta...</p>
    </div>
  </div>
</div>

<script>
/* ================= PREVENÈšIE WINDOW.STORAGE ================= */
window.storage = window.storage || {};

/* ================= CONFIG FIREBASE ================= */
const firebaseConfig = {
    apiKey: "AIzaSyD4j5pOuXalnS-TErmivkJEa-4ki5e_x6s",
    authDomain: "colindatori-buftea.firebaseapp.com",
    databaseURL: "https://colindatori-buftea-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "colindatori-buftea",
    storageBucket: "colindatori-buftea.firebasestorage.app",
    messagingSenderId: "386078081254",
    appId: "1:386078081254:web:8625f492e1a110fa257b27"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const ADMIN_PASSWORD = 'colind2025';
const ICONS = ['ğŸ„','ğŸ¬','ğŸ…','â­','ğŸ””','ğŸ','â„ï¸','ğŸ•¯ï¸'];

let map, markers = [], pins = [], selectedIcon='ğŸ„', clickedLocation=null, selectedPin=null;

document.addEventListener('DOMContentLoaded', init);

/* ================= FUNCTII ================= */
function init() {
  initMap();
  initIconGrid();
  loadPins();
  document.getElementById('add-btn').addEventListener('click', openAddModal);
}

function initMap() {
  map = L.map('map').setView([44.545593,25.931531],17);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â© OpenStreetMap contributors',maxZoom:19}).addTo(map);
  map.on('click',e=>{
    clickedLocation={lat:e.latlng.lat,lng:e.latlng.lng};
    if(window.tempMarker) window.tempMarker.remove();
    window.tempMarker=L.marker([e.latlng.lat,e.latlng.lng],{
      icon:L.divIcon({html:'<div style="font-size:48px;animation:pulse 1s infinite;">ğŸ“</div><style>@keyframes pulse{0%,100%{transform:scale(1);}50%{transform:scale(1.2);}}</style>',className:'temp-marker',iconSize:[48,48],iconAnchor:[24,48]})
    }).addTo(map);
    if(!document.getElementById('add-modal').classList.contains('hidden'))
      document.getElementById('location-success').classList.remove('hidden');
  });
  setTimeout(()=>{map.invalidateSize();document.getElementById('loading').classList.add('hidden');},100);
}

function initIconGrid(){const grid=document.getElementById('icon-grid');grid.innerHTML='';ICONS.forEach(icon=>{const btn=document.createElement('button');btn.type='button';btn.className='icon-btn';btn.textContent=icon;btn.onclick=()=>selectIcon(icon);if(icon===selectedIcon)btn.classList.add('selected');grid.appendChild(btn);});}
function selectIcon(icon){selectedIcon=icon;document.querySelectorAll('.icon-btn').forEach(btn=>btn.classList.toggle('selected',btn.textContent===icon));}

function loadPins(){database.ref('pins').on('value',snapshot=>{pins=[];snapshot.forEach(child=>pins.push({id:child.key,...child.val()}));updateMap();updatePinCount();});}
function updateMap(){markers.forEach(marker=>marker.remove());markers=[];pins.forEach(pin=>{const icon=pin.icon||'ğŸ„';const marker=L.marker([pin.lat,pin.lng],{icon:L.divIcon({html:`<div style="font-size:42px;filter:drop-shadow(0 3px 6px rgba(0,0,0,0.4));transform:translateY(-5px);">${icon}</div>`,className:'custom-marker',iconSize:[42,42],iconAnchor:[21,42]})}).addTo(map);marker.on('click',()=>showPin(pin));markers.push(marker);});}
function updatePinCount(){const count=pins.length;const text=count===1?'casÄƒ':'case';document.getElementById('pin-count-text').textContent=`${count} ${text}`;}

function showError(message){document.getElementById('error-text').textContent=message;document.getElementById('error-message').classList.remove('hidden');}
function closeError(){document.getElementById('error-message').classList.add('hidden');}

function openAddModal(){if(!clickedLocation)return alert('âš ï¸ Mai Ã®ntÃ¢i dÄƒ click pe hartÄƒ unde vrei sÄƒ adaugi casa!');document.getElementById('add-modal').classList.remove('hidden');document.getElementById('location-success').classList.remove('hidden');document.getElementById('view-modal').classList.add('hidden');}
function closeAddModal(){document.getElementById('add-modal').classList.add('hidden');document.getElementById('add-form').reset();document.getElementById('error-message').classList.add('hidden');clickedLocation=null;selectedIcon='ğŸ„';initIconGrid();if(window.tempMarker){window.tempMarker.remove();window.tempMarker=null;}}

function handleSubmit(e){
  e.preventDefault();closeError();
  const name=document.getElementById('name').value.trim();
  const address=document.getElementById('address').value.trim();
  const streetNumber=document.getElementById('streetNumber').value.trim();
  const missingFields=[];if(!name)missingFields.push('Nume Familie');if(!address)missingFields.push('Denumire StradÄƒ');if(!streetNumber)missingFields.push('NumÄƒr PoÈ™tal');
  if(missingFields.length>0)return showError('Te rog completeazÄƒ urmÄƒtoarele cÃ¢mpuri obligatorii:\n\nâ€¢ '+missingFields.join('\nâ€¢ '));
  if(!/^\d+$/.test(streetNumber))return showError('NumÄƒrul poÈ™tal trebuie sÄƒ conÈ›inÄƒ doar cifre.');
  if(!clickedLocation)return showError('Te rog selecteazÄƒ o locaÈ›ie pe hartÄƒ!');
  const pinData={name,address,streetNumber,schedule:document.getElementById('schedule').value.trim(),notes:document.getElementById('notes').value.trim(),icon:selectedIcon,password:document.getElementById('password').value.trim(),lat:clickedLocation.lat,lng:clickedLocation.lng,timestamp:new Date().toISOString()};
  database.ref('pins').push(pinData).then(()=>{closeAddModal();if(window.tempMarker){window.tempMarker.remove();window.tempMarker=null;}const successBox=document.createElement('div');successBox.className='success-box';successBox.innerHTML='<p class="success-text">âœ… CasÄƒ adÄƒugatÄƒ cu succes!</p>';document.getElementById('add-modal').prepend(successBox);setTimeout(()=>successBox.remove(),3000);}).catch(error=>{console.error('Save error:',error);showError('Eroare la salvare: '+error.message);});
}

/* ================= FUNCTII VIZUALIZARE SI STERGERE ================= */
// ... pÄƒstreazÄƒ funcÈ›iile tale showPin, closeViewModal, showDeleteForm, closeDeleteForm, confirmDelete
</script>
</body>
</html>
